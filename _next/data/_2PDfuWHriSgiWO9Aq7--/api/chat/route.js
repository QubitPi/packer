(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[46],{67:e=>{"use strict";e.exports=require("node:async_hooks")},195:e=>{"use strict";e.exports=require("node:buffer")},338:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>l}),s(639);var n=s(826),r=s(161),a=s(254);let o=a.z.object({task:a.z.string().transform(e=>e.trim()),conversationId:a.z.string().optional(),parentMessageId:a.z.string().optional()});async function i(e,t){console.log(`[${e.method}] ${e.url}`);let s=e.headers.get("authorization");if(!s)return new Response("Not found",{status:404});let n=s.split(" ")[1];if("POST"===e.method){let t=await e.json(),s=o.safeParse(t);if(!s.success)return new Response("Bad Request",{status:400});let{task:r,conversationId:a,parentMessageId:i}=s.data,l=/^simulate (\d{3}) (.*)$/i;if(r.match(l)){let[,e,t]=r.match(l);return new Response(t,{status:Number(e),statusText:t})}try{let e;a&&i?(console.log("continue conversation: %s - %s",a,i),e=await u({conversationId:a,parentMessageId:i,task:r,accessToken:n})):(console.log("create conversation"),e=await c({task:r,accessToken:n}));let t=e.headers;if(e.ok){let s=t.get("x-conversation-id"),n=t.get("x-message-id");return n||console.warn("[/api/chat/route] x-message-id header is missing from the server"),s||console.warn("[/api/chat/route] x-conversation-id header is missing from the server"),new Response(e.body,{headers:{"Content-Type":"text/event-stream; charset=utf-8","x-message-id":n,"x-conversation-id":s}})}{let t={};if(429==e.status){let s="x-ratelimit-limit",n="x-ratelimit-remaining",r="x-ratelimit-reset",a="x-ratelimit-resource",o="x-ratelimit-used";t[s]=e.headers.get(s),t[n]=e.headers.get(n),t[r]=e.headers.get(r),t[a]=e.headers.get(a),t[o]=e.headers.get(o)}return new Response(e.body,{status:e.status,headers:{...t,"Content-Type":"application/json"}})}}catch(e){return console.error(e),new Response("Internal Server Error",{status:500})}}}async function c({task:e,accessToken:t}){let s=new Headers;s.set("Authorization",`Bearer ${t}`),s.set("Content-Type","application/json");let n=new URL("/v1/conversations",process.env.EXPERIMENTAL_CHAT_API_BASE_URL),r=JSON.stringify({task:e});return await fetch(n.toString(),{body:r,method:"POST",headers:s})}async function u({conversationId:e,parentMessageId:t,task:s,accessToken:n}){let r=new Headers;r.set("Authorization",`Bearer ${n}`),r.set("Content-Type","application/json");let a=new URL(`/v1/conversations/${e}`,process.env.EXPERIMENTAL_CHAT_API_BASE_URL),o=JSON.stringify({task:s,parentMessageId:t});return await fetch(a.toString(),{body:o,method:"POST",headers:r})}function l(e){return(0,n.V)({...e,IncrementalCache:r.k,page:"/api/chat/route",handler:i})}}},e=>{var t=t=>e(e.s=t);e.O(0,[826,773],()=>t(338));var s=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_pages/api/chat/route"]=s}]);
//# sourceMappingURL=route.js.map